WITH @@files
RETURN (
  FOR v_item1
  IN [
    FIRST(
      LET v_entity1 = DOCUMENT(@@files, @var1)
      RETURN (((v_entity1.`accessGroup` == @var2) || (v_entity1.`accessGroup` == @var3)) ? v_entity1 : null)
    )._key
  ]
  FILTER (v_item1 > NULL)
  RETURN v_item1
)

// --------------------------------

WITH @@files
RETURN (FIRST(
  FOR v_item1
  IN (
    FOR v_file1
    IN @v_ids1
    FILTER !((DOCUMENT(@@files, v_file1).`accessGroup` == @var1))
    RETURN v_file1
  )
  COLLECT WITH COUNT INTO v_count1
  RETURN v_count1
) == 0)

// --------------------------------

WITH @@files
RETURN (
  FOR v_file1
  IN (
    FOR v_file2
    IN @v_ids1
    REMOVE v_file2
    IN @@files
    RETURN OLD
  )
  RETURN {
    "name": v_file1.`name`
  }
)

// --------------------------------

WITH @@files
RETURN {
  "deleteFiles": @v_deleteFiles1
}
