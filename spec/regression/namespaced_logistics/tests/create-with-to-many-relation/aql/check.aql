WITH @@deliveries, @@handlingUnits
RETURN {
  "logistics": {
    "delivery": {
      "allDeliveries": (
        FOR v_delivery1
        IN @@deliveries
        FILTER (v_delivery1.`deliveryNumber` == @var1)
        RETURN {
          "deliveryNumber": v_delivery1.`deliveryNumber`,
          "handlingUnits": (
            FOR v_handlingUnit1
            IN OUTBOUND v_delivery1 @@deliveries_handlingUnits
            FILTER v_handlingUnit1 != null
            LET v_delivery2 = FIRST((
              FOR v_node1
              IN INBOUND v_handlingUnit1 @@deliveries_handlingUnits
              FILTER v_node1 != null
              RETURN v_node1
            ))
            RETURN {
              "huNumber": v_handlingUnit1.`huNumber`,
              "delivery": (IS_NULL(v_delivery2) ? null : {
                "deliveryNumber": v_delivery2.`deliveryNumber`
              })
            }
          )
        }
      )
    }
  }
}

// Peak memory usage: 98304 bytes
