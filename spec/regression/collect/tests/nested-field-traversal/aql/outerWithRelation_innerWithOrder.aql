WITH @@deliveries
LET v_shipment1 = FIRST((
  FOR v_shipment2
  IN @@shipments
  FILTER (v_shipment2.`shipmentNumber` == @var1)
  LIMIT @var2
  RETURN v_shipment2
))
RETURN {
  "Shipment": (IS_NULL(v_shipment1) ? null : {
    "allItems": (
      FOR v_deliveryItem1
      IN FLATTEN((
        FOR v_node1, v_edge1, v_path1 IN @var3..@var4 OUTBOUND v_shipment1 @@shipments_deliveries
        FILTER v_node1._key != null
        RETURN v_node1.`deliveryContents`[*].`items`[*]
      ), 2)
      RETURN {
        "subSubItems": (
          FOR v_deliveryItem2
          IN v_deliveryItem1.`subItems`[*].`subItems`[*][**]
          SORT (v_deliveryItem2.`itemNumber`)  DESC
          RETURN {
            "itemNumber": v_deliveryItem2.`itemNumber`
          }
        )
      }
    )
  })
}

// Peak memory usage: 262144 bytes
