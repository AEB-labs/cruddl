WITH @@deliveries, @@orders
LET v_shipment1 = FIRST((
  FOR v_shipment2
  IN @@shipments
  FILTER (v_shipment2.`shipmentNumber` == @var1)
  LIMIT @var2
  RETURN v_shipment2
))
RETURN {
  "Shipment": (IS_NULL(v_shipment1) ? null : {
    "totalWeightInKg": FIRST(
      FOR v_item1
      IN (
        FOR v_root1, v_edge1, v_path1 IN @var3..@var4 OUTBOUND v_shipment1 @@shipments_deliveries
        FILTER v_root1._key != null
        FOR v_item2 IN v_root1.`deliveryContents`[*].`items`[*][**].`weightInKg`
        RETURN v_item2
      )
      FILTER v_item1 != null
      COLLECT AGGREGATE v_sum1 = SUM(v_item1)
      RETURN v_sum1 != null ? v_sum1 : 0
    ),
    "maxPriority": FIRST(
      FOR v_item3
      IN (
        FOR v_node1, v_edge2, v_path2 IN @var5..@var6 OUTBOUND v_shipment1 @@shipments_deliveries
        FILTER v_node1._key != null
        RETURN v_node1.`priority`
      )
      FILTER v_item3 != null
      COLLECT AGGREGATE v_max1 = MAX(v_item3)
      RETURN v_max1
    ),
    "itemCount": FIRST(
      FOR v_item4
      IN (
        FOR v_root2, v_edge3, v_path3 IN @var7..@var8 OUTBOUND v_shipment1 @@shipments_deliveries
        FOR v_item5 IN v_root2.`deliveryContents`[*].`items`[*][**]
        RETURN v_item5
      )
      COLLECT WITH COUNT INTO v_count1
      RETURN v_count1
    ),
    "allDeliveriesHaveOrders": FIRST(
      FOR v_item6
      IN (
        FOR v_node2, v_edge4, v_path4 IN @var9..@var10 OUTBOUND v_shipment1 @@shipments_deliveries
        LET v_node3 = FIRST(FOR v_node4, v_edge5, v_path5 IN @var11..@var12 OUTBOUND v_node2 @@deliveries_order FILTER v_node4._key != NULL RETURN v_node4)
        RETURN v_node3
      )
      COLLECT AGGREGATE v_none_null1 = MAX(v_item6 == null)
      RETURN v_none_null1 < true
    ),
    "allDeliveriesHaveOriginalOrders": FIRST(
      FOR v_item7
      IN (
        FOR v_node5, v_edge6, v_path6 IN @var13..@var14 OUTBOUND v_shipment1 @@shipments_deliveries
        LET v_nullableNode1 = FIRST(FOR v_node6, v_edge7, v_path7 IN @var15..@var16 OUTBOUND v_node5 @@deliveries_order FILTER v_node6._key != NULL RETURN v_node6)
        LET v_node7 = FIRST(FOR v_node8, v_edge8, v_path8 IN @var17..@var18 OUTBOUND v_nullableNode1 @@orders_originalOrder FILTER v_node8._key != NULL RETURN v_node8)
        RETURN v_node7
      )
      COLLECT AGGREGATE v_none_null2 = MAX(v_item7 == null)
      RETURN v_none_null2 < true
    ),
    "allDeliveriesArePayed": FIRST(
      FOR v_item8
      IN (
        FOR v_node9, v_edge9, v_path9 IN @var19..@var20 OUTBOUND v_shipment1 @@shipments_deliveries
        LET v_node10 = FIRST(FOR v_node11, v_edge10, v_path10 IN @var21..@var22 OUTBOUND v_node9 @@deliveries_order FILTER v_node11._key != NULL RETURN v_node11)
        RETURN v_node10.`payedAt`
      )
      COLLECT AGGREGATE v_none_null3 = MAX(v_item8 == null)
      RETURN v_none_null3 < true
    ),
    "allDeliveryLocationIdentCodes": (
      FOR v_item9
      IN (
        FOR v_node12, v_edge11, v_path11 IN @var23..@var24 OUTBOUND v_shipment1 @@shipments_deliveries
        FILTER v_node12._key != null
        RETURN v_node12.`location`.`identCode`
      )
      FILTER v_item9 != null
      SORT v_item9
      COLLECT v_distinct1 = v_item9
      RETURN v_distinct1
    ),
    "numberOfDeliveriesWithoutOrder": FIRST(
      FOR v_item10
      IN (
        FOR v_node13, v_edge12, v_path12 IN @var25..@var26 OUTBOUND v_shipment1 @@shipments_deliveries
        LET v_node14 = FIRST(FOR v_node15, v_edge13, v_path13 IN @var27..@var28 OUTBOUND v_node13 @@deliveries_order FILTER v_node15._key != NULL RETURN v_node15)
        RETURN v_node14
      )
      FILTER v_item10 == null
      COLLECT AGGREGATE v_count_null1 = COUNT(v_item10)
      RETURN v_count_null1
    ),
    "numberOfDeliveriesWithoutOriginalOrder": FIRST(
      FOR v_item11
      IN (
        FOR v_node16, v_edge14, v_path14 IN @var29..@var30 OUTBOUND v_shipment1 @@shipments_deliveries
        LET v_nullableNode2 = FIRST(FOR v_node17, v_edge15, v_path15 IN @var31..@var32 OUTBOUND v_node16 @@deliveries_order FILTER v_node17._key != NULL RETURN v_node17)
        LET v_node18 = FIRST(FOR v_node19, v_edge16, v_path16 IN @var33..@var34 OUTBOUND v_nullableNode2 @@orders_originalOrder FILTER v_node19._key != NULL RETURN v_node19)
        RETURN v_node18
      )
      FILTER v_item11 == null
      COLLECT AGGREGATE v_count_null2 = COUNT(v_item11)
      RETURN v_count_null2
    ),
    "numberOfDeliveriesWithoutPayedOrder": FIRST(
      FOR v_item12
      IN (
        FOR v_node20, v_edge17, v_path17 IN @var35..@var36 OUTBOUND v_shipment1 @@shipments_deliveries
        LET v_node21 = FIRST(FOR v_node22, v_edge18, v_path18 IN @var37..@var38 OUTBOUND v_node20 @@deliveries_order FILTER v_node22._key != NULL RETURN v_node22)
        RETURN v_node21.`payedAt`
      )
      FILTER v_item12 == null
      COLLECT AGGREGATE v_count_null3 = COUNT(v_item12)
      RETURN v_count_null3
    ),
    "startedDispatchingAt": FIRST(
      FOR v_item13
      IN (
        FOR v_offsetDateTime1
        IN (
          FOR v_node23, v_edge19, v_path19 IN @var39..@var40 OUTBOUND v_shipment1 @@shipments_deliveries
          FILTER v_node23._key != null
          RETURN v_node23.`dispatchedAt`
        )
        RETURN v_offsetDateTime1.`timestamp`
      )
      FILTER v_item13 != null
      COLLECT AGGREGATE v_min1 = MIN(v_item13)
      RETURN v_min1
    ),
    "fullyDispatchedAt": FIRST(
      FOR v_item14
      IN (
        FOR v_offsetDateTime2
        IN (
          FOR v_node24, v_edge20, v_path20 IN @var41..@var42 OUTBOUND v_shipment1 @@shipments_deliveries
          FILTER v_node24._key != null
          RETURN v_node24.`dispatchedAt`
        )
        RETURN v_offsetDateTime2.`timestamp`
      )
      FILTER v_item14 != null
      COLLECT AGGREGATE v_max2 = MAX(v_item14)
      RETURN v_max2
    ),
    "allOrders": (
      FOR v_order1
      IN (
        FOR v_item15
        IN (
          FOR v_node25, v_edge21, v_path21 IN @var43..@var44 OUTBOUND v_shipment1 @@shipments_deliveries
          FOR v_node26, v_edge22, v_path22 IN @var45..@var46 OUTBOUND v_node25 @@deliveries_order
          RETURN v_node26
        )
        FILTER v_item15 != null
        COLLECT v_distinct2 = v_item15
        RETURN v_distinct2
      )
      SORT (v_order1.`orderNumber`)
      RETURN {
        "orderNumber": v_order1.`orderNumber`
      }
    )
  })
}
