WITH @@deliveries
LET v_shipment1 = FIRST((
  FOR v_shipment2
  IN @@shipments
  FILTER (v_shipment2.`shipmentNumber` == @var1)
  LIMIT @var2
  RETURN v_shipment2
))
RETURN {
  "Shipment": (IS_NULL(v_shipment1) ? null : {
    "allItems": (
      FOR v_item1 IN (FLATTEN((
        FOR v_node1, v_edge1, v_path1 IN @var3..@var4 OUTBOUND v_shipment1 @@shipments_deliveries
        FILTER v_node1._key != null
        RETURN v_node1.`deliveryContents`[*].`items`[* RETURN {
          item: {
            "itemNumber": CURRENT.`itemNumber`
          },
          sortValues: [
            CURRENT.`itemNumber`
          ]
        }]
      ), 2))
      SORT v_item1.sortValues[0]
      RETURN v_item1.item
    ),
    "allDeliveryContents": (
      FOR v_item2 IN ((
        FOR v_node2, v_edge2, v_path2 IN @var5..@var6 OUTBOUND v_shipment1 @@shipments_deliveries
        FILTER v_node2._key != null
        RETURN v_node2.`deliveryContents`[* RETURN {
          item: {
            "deliveryContentNumber": CURRENT.`deliveryContentNumber`
          },
          sortValues: [
            CURRENT.`deliveryContentNumber`
          ]
        }]
      )[**])
      SORT v_item2.sortValues[0]
      RETURN v_item2.item
    )
  })
}
