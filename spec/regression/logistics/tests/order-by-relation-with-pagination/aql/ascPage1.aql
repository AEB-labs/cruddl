WITH @@deliveries
RETURN {
  "allHandlingUnits": (
    FOR v_handlingUnit1
    IN @@handlingUnits
    SORT (FIRST((
      FOR v_node1
      IN INBOUND v_handlingUnit1 @@deliveries_handlingUnits
      FILTER v_node1 != null
      RETURN v_node1
    )).`deliveryNumber`) , (v_handlingUnit1._key)
    LIMIT @var1
    LET v_delivery1 = FIRST((
      FOR v_node2
      IN INBOUND v_handlingUnit1 @@deliveries_handlingUnits
      FILTER v_node2 != null
      RETURN v_node2
    ))
    RETURN {
      "huNumber": v_handlingUnit1.`huNumber`,
      "delivery": (IS_NULL(v_delivery1) ? null : {
        "deliveryNumber": v_delivery1.`deliveryNumber`
      }),
      @var2: JSON_STRINGIFY({
        "delivery_deliveryNumber": FIRST((
          FOR v_node3
          IN INBOUND v_handlingUnit1 @@deliveries_handlingUnits
          FILTER v_node3 != null
          RETURN v_node3
        )).`deliveryNumber`,
        "id": v_handlingUnit1._key
      })
    }
  )
}

// Peak memory usage: 131072 bytes
