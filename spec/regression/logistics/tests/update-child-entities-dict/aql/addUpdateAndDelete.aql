RETURN (
  FOR v_currentEntity1
  IN (
    FOR v_delivery1
    IN @@deliveries
    FILTER (v_delivery1._key == @var1)
    LIMIT @var2
    RETURN v_delivery1
  )
  UPDATE v_currentEntity1
  WITH {
    "items": (
      LET v_items1 = (
        FOR v_deliveryItem1
        IN UNION((IS_LIST(v_currentEntity1.`items`) ? v_currentEntity1.`items` : []), @var3)
        FILTER !((v_deliveryItem1.`id` IN @var4))
        RETURN v_deliveryItem1
      )
      LET v_itemsWithIndex1 = (
        FOR v_indexVar1
        IN LENGTH(v_items1) > 0 ? 0..(LENGTH(v_items1) - 1) : []
        RETURN MERGE(NTH(v_items1, v_indexVar1), { __index: v_indexVar1 })
      )
      LET v_dict1 = ZIP(v_items1[*].id, v_itemsWithIndex1)
      LET v_updatedDict1 = MERGE(v_dict1, {
        @var5: MERGE(v_dict1[@var6], {
          "itemNumber": @var7,
          "updatedAt": @var8
        }),
        @var9: MERGE(v_dict1[@var10], {
          "itemNumber": @var11,
          "updatedAt": @var12
        })
      })
      FOR v_item1
      IN VALUES(v_updatedDict1)
      FILTER v_item1.__index != null
      SORT v_item1.__index
      RETURN UNSET(v_item1, '__index')
    ),
    "updatedAt": @var13
  }
  IN @@deliveries
  OPTIONS { mergeObjects: false }
  RETURN NEW._key
)

// Peak memory usage: 98304 bytes

// ----------------------------------------------------------------

WITH @@deliveries
LET v_delivery1 = DOCUMENT(@@deliveries, @var1)
RETURN (IS_NULL(v_delivery1) ? null : {
  "items": (
    FOR v_deliveryItem1
    IN (IS_LIST(v_delivery1.`items`) ? v_delivery1.`items` : [])
    RETURN {
      "id": v_deliveryItem1.`id`,
      "itemNumber": v_deliveryItem1.`itemNumber`
    }
  )
})

// Peak memory usage: 32768 bytes

// ----------------------------------------------------------------

WITH @@deliveries
RETURN {
  "updateDelivery": @v_updateDelivery1
}

// Peak memory usage: 0 bytes
