LET v_delivery1 = FIRST((
  FOR v_delivery2
  IN @@deliveries
  FILTER (v_delivery2._key == @var1)
  LIMIT @var2
  RETURN v_delivery2
))
RETURN {
  "Delivery": (IS_NULL(v_delivery1) ? null : {
    "deliveryNumber": v_delivery1.`deliveryNumber`,
    "items": (
      FOR v_deliveryItem1
      IN v_delivery1.`items`[*]
      RETURN {
        "itemNumber": v_deliveryItem1.`itemNumber`,
        "handlingUnit": FIRST(
          LET v_handlingUnit1 = (IS_NULL(v_deliveryItem1.`handlingUnit`) ? null : FIRST((
            FOR v_handlingUnit2
            IN @@handlingUnits
            FILTER ((v_handlingUnit2._key > NULL) && (v_handlingUnit2._key == v_deliveryItem1.`handlingUnit`))
            LIMIT @var3
            RETURN v_handlingUnit2
          )))
          RETURN (IS_NULL(v_handlingUnit1) ? null : {
            "id": v_handlingUnit1._key,
            "huNumber": v_handlingUnit1.`huNumber`
          })
        )
      }
    )
  })
}

// Peak memory usage: 98304 bytes
