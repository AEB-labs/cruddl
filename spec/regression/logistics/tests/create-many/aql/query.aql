WITH @@handlingUnits
RETURN {
  "allDeliveries": (
    FOR v_delivery1
    IN @@deliveries
    SORT (v_delivery1.`deliveryNumber`)
    LIMIT @var1
    LET v_country1 = (IS_NULL(v_delivery1.`consignee`.`country`) ? null : FIRST((
      FOR v_country2
      IN @@countries
      FILTER ((v_country2.`isoCode` > NULL) && (v_country2.`isoCode` == v_delivery1.`consignee`.`country`))
      LIMIT @var2
      RETURN v_country2
    )))
    LET v_country3 = (IS_NULL(v_delivery1.`destinationCountryISOCode`) ? null : FIRST((
      FOR v_destinationCountry1
      IN @@countries
      FILTER ((v_destinationCountry1.`isoCode` > NULL) && (v_destinationCountry1.`isoCode` == v_delivery1.`destinationCountryISOCode`))
      LIMIT @var3
      RETURN v_destinationCountry1
    )))
    RETURN {
      "deliveryNumber": v_delivery1.`deliveryNumber`,
      "consignee": (IS_NULL(v_delivery1.`consignee`) ? null : {
        "city": v_delivery1.`consignee`.`city`,
        "country": (IS_NULL(v_country1) ? null : {
          "isoCode": v_country1.`isoCode`,
          "description": v_country1.`description`[* RETURN {
            "languageIsoCode": CURRENT.`languageIsoCode`,
            "translation": CURRENT.`translation`
          }]
        }),
        "street": v_delivery1.`consignee`.`street`
      }),
      "contentInfo": v_delivery1.`contentInfo`[* RETURN {
        "translation": CURRENT.`translation`,
        "languageIsoCode": CURRENT.`languageIsoCode`
      }],
      "destinationCountry": (IS_NULL(v_country3) ? null : {
        "isoCode": v_country3.`isoCode`
      }),
      "dgInfo": {
        "flashpoint": v_delivery1.`dgInfo`.`flashpoint`,
        "unNumber": v_delivery1.`dgInfo`.`unNumber`,
        "notices": v_delivery1.`dgInfo`.`notices`[*]
      },
      "serialNumbers": v_delivery1.`serialNumbers`[*],
      "items": v_delivery1.`items`[* RETURN {
        "itemNumber": CURRENT.`itemNumber`
      }],
      "handlingUnits": (
        FOR v_handlingUnit1
        IN OUTBOUND v_delivery1 @@deliveries_handlingUnits
        FILTER v_handlingUnit1._key != null
        SORT (v_handlingUnit1.`huNumber`)
        RETURN {
          "huNumber": v_handlingUnit1.`huNumber`
        }
      )
    }
  )
}

// Peak memory usage: 98304 bytes
